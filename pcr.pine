// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Sector Tracker - Put/Call Ratio Indicator

//@version=6
indicator("Put/Call Ratio", overlay=false, precision=3)

// Source: USI:PCC = CBOE Put/Call Ratio (Equities + Indices), USI:PCSPX = SPX Put/Call Ratio
pcrSource = input.string("USI:PCC", "PCR Source", options=["USI:PCC", "USI:PCSPX"], group="Data")
showSkew = input.bool(true, "Show Skew Index", group="Data")

// Fetch pre-calculated Put/Call ratio from TradingView's US Indices
pcr = request.security(pcrSource, timeframe.period, close, gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

// Fetch CBOE Skew Index (measures implied volatility skew between OTM puts and calls; tail risk)
skew = request.security("CBOE:SKEW", timeframe.period, close, gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
// Normalize SKEW (100-150) to ~1.0-1.5 range for display alongside PCR; label shows actual value
skewNorm = skew / 100.0

// Optional: smoothed PCR with EMA for less noise
pcrSmooth = ta.ema(pcr, 5)

// Plot
plot(pcr, color=color.new(color.purple, 0), linewidth=2, title="Put/Call Ratio")
plot(pcrSmooth, color=color.new(color.teal, 0), linewidth=1, title="PCR (5 EMA)")
plot(showSkew ? skewNorm : na, color=color.new(color.orange, 0), linewidth=2, title="Skew Index (÷100)")

// Floating labels at end of each line
var label lblPcr = na
var label lblPcrSmooth = na
var label lblSkew = na
if barstate.islast
    label.delete(lblPcr)
    label.delete(lblPcrSmooth)
    label.delete(lblSkew)
    if not na(pcr)
        lblPcr := label.new(bar_index, pcr + 0.025, "PCR: " + str.tostring(pcr, format.mintick), style=label.style_label_left, color=color.purple, textcolor=color.white, size=size.small)
    if not na(pcrSmooth)
        lblPcrSmooth := label.new(bar_index, pcrSmooth, "PCR(5): " + str.tostring(pcrSmooth, format.mintick), style=label.style_label_left, color=color.teal, textcolor=color.white, size=size.small)
    if showSkew and not na(skew)
        lblSkew := label.new(bar_index, skewNorm + 0.025, "SKEW: " + str.tostring(skewNorm, format.mintick), style=label.style_label_left, color=color.orange, textcolor=color.white, size=size.small)

// Reference lines for interpretation
hline(1.0, "Neutral", color=color.gray, linestyle=hline.style_dashed)
hline(1.2, "Bearish Extreme", color=color.red, linestyle=hline.style_dotted)
hline(0.8, "Bullish Extreme", color=color.green, linestyle=hline.style_dotted)
